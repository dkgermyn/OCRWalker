from collections import namedtuple
import os
import shutil
import webbrowser

from PIL import Image
import jinja2


# sample_image = "23560.png"
# sample_output = { 'level': [1, 2, 3, 4, 5, 5, 5, 2, 3, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 5, 5, 5, 5, 5, 5, 2, 3, 4, 5, 2, 3, 4, 5, 5, 5, 2, 3, 4, 5, 5, 5, 2, 3, 4, 5, 2, 3, 4, 5, 5, 5, 2, 3, 4, 5, 5, 5],  'page_num': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],  'block_num': [0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8],  'par_num': [0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1],  'line_num': [0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1],  'word_num': [0, 0, 0, 0, 1, 2, 3, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 1, 2, 3, 4, 5, 6, 0, 0, 0, 1, 0, 0, 0, 1, 2, 3, 0, 0, 0, 1, 2, 3, 0, 0, 0, 1, 0, 0, 0, 1, 2, 3, 0, 0, 0, 1, 2, 3],  'left': [0, 350, 350, 350, 350, 3099, 4010, 359, 359, 359, 359, 1478, 1869, 2993, 3217, 3606, 3814, 4137, 5446, 5840, 374, 374, 1448, 1754, 2148, 2420, 3458, 4096, 4749, 5377, 374, 374, 1025, 1876, 2101, 2686, 3200, 5208, 5208, 5208, 5208, 372, 372, 372, 372, 418, 4609, 373, 373, 373, 373, 790, 2147, 348, 348, 348, 348, 597, 597, 597, 597, 1582, 2870, 4959, 4950, 4959, 4959, 5169, 5587],  'top': [0, 395, 395, 395, 399, 409, 395, 1610, 1610, 1610, 1621, 1676, 1673, 1624, 1673, 1634, 1654, 1610, 1614, 1614, 1964, 1966, 2006, 1971, 1971, 1964, 1970, 2020, 2019, 1968, 2316, 2375, 2373, 2316, 2321, 2372, 2327, 394, 394, 394, 394, 2850, 2850, 2850, 4188, 2850, 3554, 4186, 4186, 4186, 4186, 4247, 4247, 4860, 4860, 4860, 4860, 5023, 5023, 5023, 5023, 5023, 5064, 5494, 5494, 5494, 5499, 5498, 5494],  'width': [7016, 4869, 4869, 4869, 2545, 714, 1209, 5822, 5822, 5680, 1038, 296, 1033, 134, 290, 92, 233, 1241, 309, 199, 5807, 993, 231, 301, 192, 961, 565, 584, 551, 804, 3720, 560, 772, 134, 499, 426, 894, 23, 23, 23, 23, 4830, 4830, 4830, 1, 958, 593, 2134, 2134, 2134, 324, 1296, 360, 2860, 2860, 2860, 2860, 2380, 2380, 2380, 911, 1213, 107, 1689, 1698, 1689, 138, 352, 1061], 'height': [5846, 983, 983, 983, 974, 950, 983, 988, 988, 276, 265, 159, 165, 204, 165, 191, 181, 233, 227, 230, 232, 223, 184, 216, 213, 226, 220, 167, 172, 228, 282, 212, 166, 219, 216, 166, 271, 984, 984, 984, 984, 1660, 1660, 1660, 322, 964, 710, 327, 327, 327, 327, 204, 203, 522, 522, 522, 522, 220, 220, 220, 220, 173, 105, 182, 182, 182, 135, 138, 182],  'conf': [-1, -1, -1, -1, 80, 84, 73, -1, -1, -1, 85, 91, 86, 90, 88, 89, 85, 85, 88, 87, -1, 85, 83, 86, 87, 86, 85, 87, 84, 86, -1, 90, 89, 86, 86, 88, 84, -1, -1, -1, 95, -1, -1, -1, 95, 95, 95, -1, -1, -1, 81, 69, 86, -1, -1, -1, 95, -1, -1, -1, 84, 81, 86, -1, -1, -1, 65, 70, 59],  'text': ['', '', '', '', 'SAUTEZ', 'lE', 'M8', '', '', '', 'Adoptez', 'un', 'nouveau', '2', 'en', '1', 'et', 'bénéﬁciez', 'de', 'la', '', 'mobilité', 'et', 'de', 'la', 'sécurité', 'dont', 'vous', 'avez', 'besoin', '', 'pour', 'mener', 'à', 'bien', 'vos', 'projets.', '', '', '', ' ', '', '', '', ' ', ' ', ' ', '', '', '', '.', 'WindowsîO', 'Pro', '', '', '', ' ', '', '', '', 'Changez', 'maintenant', '>', '', '', '', 'E?', 'lrtel', 'Corpu5tbﬂ.']}

sample_image = "20388.png"
sample_output = {'level': [1, 2, 3, 4, 5, 5, 2, 3, 4, 5, 2, 3, 4, 5, 4, 5, 5, 5, 4, 5, 5, 5, 2, 3, 4, 5, 5, 5, 5, 4, 5, 5, 5, 2, 3, 4, 5, 2, 3, 4, 5, 5, 5, 4, 5, 5], 'page_num': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], 'block_num': [0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6], 'par_num': [0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1], 'line_num': [0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 2, 2, 2], 'word_num': [0, 0, 0, 0, 1, 2, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 2, 3, 0, 1, 2, 3, 0, 0, 0, 1, 2, 3, 4, 0, 1, 2, 3, 0, 0, 0, 1, 0, 0, 0, 1, 2, 3, 0, 1, 2], 'left': [0, 5093, 5093, 5093, 5093, 5627, 5637, 5637, 5637, 5637, 304, 304, 312, 312, 313, 313, 1415, 2354, 304, 304, 2467, 3355, 528, 528, 528, 528, 1173, 1491, 3401, 851, 851, 1488, 3456, 2331, 2331, 2331, 2331, 319, 319, 543, 543, 3313, 5422, 319, 319, 4268], 'top': [0, 298, 298, 298, 298, 374, 599, 599, 599, 599, 325, 325, 325, 325, 951, 955, 951, 951, 1578, 1578, 1578, 1716, 2415, 2367, 2415, 2495, 2422, 2516, 2415, 2619, 2797, 2619, 2807, 328, 328, 328, 328, 950, 950, 950, 1648, 950, 1146, 2283, 2283, 2628], 'width': [7016, 1612, 1612, 1612, 470, 1078, 559, 559, 559, 559, 3257, 4227, 2019, 2019, 3000, 1001, 820, 959, 3257, 2115, 433, 206, 2984, 2984, 2929, 416, 20, 365, 56, 2661, 140, 1629, 56, 1, 1, 1, 1, 6494, 6494, 5775, 1, 1, 896, 6494, 883, 2545], 'height': [3658, 314, 314, 314, 314, 162, 80, 80, 80, 80, 2095, 2146, 564, 564, 564, 560, 564, 564, 842, 842, 564, 634, 611, 659, 401, 235, 28, 73, 401, 407, 229, 327, 73, 550, 550, 550, 550, 2505, 2505, 1180, 482, 566, 917, 1172, 896, 827], 'conf': [-1, -1, -1, -1, 68, 76, -1, -1, -1, 72, -1, -1, -1, 77, -1, 78, 75, 73, -1, 73, 78, 47, -1, -1, -1, 50, 45, 64, 45, -1, 55, 42, 85, -1, -1, -1, 95, -1, -1, -1, 95, 95, 95, -1, 95, 95], 'text': ['', '', '', '', '@', 'OPTANE‘)»', '', '', '', 'MEMORY', '', '', '', 'PR"PSEZ', '', '|EUX', 'F||S', 'Plus', '', "'VANÏAG", 'ES', '“:', '', '', '', 'Q“_Ëä', '.', 'uuuuuu', '{:', '', ';…', '2FÛISÊËÏËËSWÉ', '.', '', '', '', ' ', '', '', '', ' ', ' ', ' ', '', '  ', '']}






report_dir = "report"
report_media_dir = os.path.join(report_dir, "static")

Result = namedtuple(
    "Result",
    [
        "cropped_image_path",
        "detected_text",
        "possible_matches"
    ]
)

template = """
<html>
 <head>
    <style>
        img {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <img src={{ src_img_path }}>
    <h1>{{ title }}</h1>
    {% for result in results %}
    <div>
        <img src={{ result.cropped_image_path }}>
        <h2>{{ result.detected_text }}</h2>
        <ul>
            {% for match in result.possible_matches %}
            <li>{{ match }}</li>
            {% endfor %}
        </ul>
    <div>
    {% endfor %}
</body>
</html>
"""

if __name__ == '__main__':
    
    data = sample_output
    src_img_path = sample_image
    src_img = Image.open(src_img_path)

    shutil.rmtree(report_media_dir, ignore_errors=True)
    os.makedirs(report_media_dir)

    results = []
    
    for i, match in enumerate(data['text']):
        
        left =  data['left'][i]
        upper = data['top'][i]
        right = left + data['width'][i]
        lower = upper + data['height'][i]

        bounding_box = left, upper, right, lower

        if match.strip():
            cropped_image_path = os.path.join(report_media_dir, "{}.jpg".format(i))
            src_img.crop(bounding_box).save(cropped_image_path)
            results.append(
                Result(
                    os.path.relpath(cropped_image_path, report_dir),
                    match,
                    ["fake", "fake", "butts"]
                )
            )

    outfile = os.path.join(report_dir, "index.html")
    title = os.path.basename(src_img_path)

    rtemplate = jinja2.Environment().from_string(template)
    data = rtemplate.render({
        "title":        title,
        "src_img_path": os.path.relpath(src_img_path, report_dir),
        "results":      results,
    })
    with open(outfile, 'w') as f:
        f.write(data)

    webbrowser.open(outfile)

